---
title: "Prediction Regression"
output: html_document
---

## Employee Churn
# Prediction LogRegression
```{r}
library(readxl)
library(ggplot2)
library(tidyr)
library(stringr)
library(lubridate)
library(mltools)
library(data.table)
library(mlbench)
library(tidyverse)
library(magrittr)

#Regr
library(caret)
library(h2o)
h2o.init()

```

## Datenimport und -vorbereitung
```{r}
# Datenset nach One-Hot-Encoding
hot_df <- read_xlsx("20220110_dataPrepped_afterOneHot.xlsx")
hot_df <- subset(hot_df, 
                  select = -c(EmployeeChurned_0, `start_Cost center`,
                              `start_Calendar Year/Month`,
                              `LastActive_Calendar Year/Month`))

colnames(hot_df)[colnames(hot_df) == "EmployeeChurned_1"] <- "EmployeeChurned"

# Kategorische Variablen
factorColsOneHot <- c("Gender",
                "TemporaryPersonel",
                "Part Time Mark",
                "NonExempt",
                "start_NonExempt",
                "development to exempt",
                "Vertical_Horizontal_Developments_>= 3",
                "Vertical_Horizontal_Developments_0",
                "Vertical_Horizontal_Developments_1-2",
                "start_contract type_apprentice",
                "start_contract type_permanent staff",
                "start_contract type_temporary personnel",
                "start_Part time mark",
                "EmployeeChurned",
                "decrease_Category_Customer",
                "decrease_Category_GB Management",
                "decrease_Category_GBR/N",
                "decrease_Category_GTU GD",
                "decrease_Category_Human Resources GBS",
                "decrease_Category_Intellectual Property",
                "decrease_Category_IT Service CC",
                "decrease_Category_People",
                "decrease_Category_Planning & Development",
                "decrease_Category_Procurement Services - GP",
                "decrease_Category_RAA/A Competence",
                "decrease_Category_Safety",
                "decrease_Category_Supplier & Reporting",
                "Nationality_Classification_EU",
                "Nationality_Classification_German",
                "Nationality_Classification_Other",
                "Paybands_A",
                "Paybands_B",
                "Paybands_C",
                "Paybands_D",
                "Paybands_E",
                "Paybands_F",
                "Paybands_G",
                "Paybands_H")

# Umwandlung in kategorische Variablen
hot_df %<>% mutate_at(factorColsOneHot, factor)

#Indexspalte
#hot_df$index <- 1:nrow(hot_df)



# Rohdatenset ohne One-Hot-Encoding
raw_df <- read_xlsx("20220110_dataPrepped_beforeOneHot.xlsx")

raw_df <- subset(raw_df, 
                  select = -c(`start_Cost center`,
                              `start_Calendar Year/Month`,
                              `LastActive_Calendar Year/Month`))

# Kategorische Variablen
factorCols <- c("Gender",
                "TemporaryPersonel",
                "Part Time Mark",
                "NonExempt",
                "start_NonExempt",
                "development to exempt",
                "Vertical_Horizontal_Developments",
                "start_contract type",
                "start_Part time mark",
                "EmployeeChurned",
                "decrease_Category",
                "Nationality_Classification",
                "Paybands")

raw_df %<>% mutate_at(factorCols, factor)
```

## Train Test Split (Caret)
```{r}
head(hot_df)
#stratified random split (caret)
inTrain <- createDataPartition(y=hot_df$EmployeeChurned, p = .75, list=FALSE)

training <- hot_df[ inTrain,]
testing  <- hot_df[-inTrain,]

str(training)
str(testing)
```

## Regression ohne h2o Beispiele (Block später löschen)
```{r}
glm1 <- glm(formula = training$Age ~ training$EmployeeChurned, family = binomial, data = training)
glm1

pre1 <- predict(glm1, type = 'response')

summary(glm1)
summary(pre1)

plot(pre2)

```

```{r}
# # Umwandlung in h2o-Dataframe
# trainingH2O <- as.h2o(training)
# testingH2O <- as.h2o(testing)
# 
# predictors <- c(factorCols, "Month Of Service", "Age", "Months Since Last Development")
# response <- "EmployeeChurned"
# 
# h2oFit <- h2o.glm(x = predictors,
#                   y = response,
#                   training_frame = trainingH2O)
```

```{r}
df_test <- subset(hot_df, select = c("EmployeeChurned", "development to exempt", "Month Of Service"))
df <- data.frame(df_test)

LRModel <- glm()

```



